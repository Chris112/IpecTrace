<!-- about.html -->
<!-- Desc: Lookup consignment of items and display selected barcodes -->
<head>

<link rel="stylesheet" type="text/css" href="lib/demo.css">
<link rel="stylesheet" type="text/css" href="lib/jquery-ui.min.css">
<script type="text/javascript" src="lib/jquery.js"></script>
<script type="text/javascript" src="lib/jquery-ui.min.js"></script>
    <script src="lib/json2.js"></script>
    <script src="lib/jsonlint.js"></script>
	<script src="validJSON.js"></script>






</head>
<body>
    <div class="jumbotron text-center">
	<div class="row">
	<div class="col-md-4"></div>
	<div class="col-md-4">
        <h1>Track Consignment</h1>

        <p>{{ message }}</p>
		<p>Enter Consignment number : <input type="text" ng-model="conID"></p>
		
		
<form name="consignmentSearchForm" method="POST" action="https://online.toll.com.au/trackandtrace/traceConsignments.do" <table cellpadding="0" cellspacing="0" style="width: 300px;" > <tr><td>Track up to 10 consignments with Toll Online:</td></tr> <tr><td><textarea class="track" style="width: 300px;" rows="6" name="consignments" ></textarea></td></tr> <tr><td style="text-align: right"><a href="javascript:document.consignmentSearchForm.submit();"><strong>SUBMIT</strong></a></td></tr> </table> </form>
		
		
		
		
		<!--<md-button class="md-primary md-raised md-cornered">Track</md-button>-->
		<button type="button" class="btn btn-primary">Track</button>
	</div>
	</div>
	
<script>

var itemCount = 0;
var destSuburb = "none";
var destPostcode = -1;
var destAddress = "none";
var destName = "none";
var items = [];

function Item(itemNumber)
{
	this.itemNumber = itemNumber;
	this.itemLoc = "";
	this.lastScan = "";
	this.status = "No scan found";

}



//function reqListener () {
    //var reply = this.responseText;
    //console.log(this.responseText);
	alert("loaded con data.")
	var validJSON = JSON.stringify(jsonlint.parse(reply), null, "  ");
	//console.log(validJSON);
	var parsedJSON = JSON.parse(validJSON);
	
	itemCount = parsedJSON['trackeableEntities']['trackeableEntity']['0']['numItems'];
	destSuburb = parsedJSON['trackeableEntities']['trackeableEntity']['0']['receiver']['suburb'];
	destPostcode = parsedJSON['trackeableEntities']['trackeableEntity']['0']['receiver']['postcode'];
	destAddress = parsedJSON['trackeableEntities']['trackeableEntity']['0']['receiver']['address1'];
	destname = parsedJSON['trackeableEntities']['trackeableEntity']['0']['receiver']['name'];
	
	var eventTime;
	var eventDesc;
	var eventLoc;
	var attributeCount;
	var attributeName;
	var attributeLabel;
	var currItem;
	// find out how many events the con has than loop through them and find items
	var eventCount = parsedJSON['trackeableEntities']['trackeableEntity']['0']['events']['trackeableEntityEventCount'];
	for (i=eventCount-1;i>=0;i--) {
		eventTime = parsedJSON['trackeableEntities']['trackeableEntity']['0']['events']['trackeableEntityEvent'][i]['dateTime'];
		eventLoc = parsedJSON['trackeableEntities']['trackeableEntity']['0']['events']['trackeableEntityEvent'][i]['location'];
		eventDesc = parsedJSON['trackeableEntities']['trackeableEntity']['0']['events']['trackeableEntityEvent'][i]['description'];
		//console.log(eventDesc);
		// if event has attributes, parse them
		if (parsedJSON['trackeableEntities']['trackeableEntity'][0]['events']['trackeableEntityEvent'][i]['attributes'] != undefined) {
			attributeCount = parsedJSON['trackeableEntities']['trackeableEntity'][0]['events']['trackeableEntityEvent'][i]['attributes']['attributeCount'];
			for (f=attributeCount-1;f>=0;f--) {
				//console.log('looking at event ' + i + ' and attribute ' + f);
				attributeName = parsedJSON['trackeableEntities']['trackeableEntity']['0']['events']['trackeableEntityEvent'][i]['attributes']['attribute'][f]['name'];
				// If the current attribute is ITEM_NUMBER then an item has been detected
				if (attributeName == 'ITEM_NUMBER') {
					attributeLabel = parsedJSON['trackeableEntities']['trackeableEntity']['0']['events']['trackeableEntityEvent'][i]['attributes']['attribute'][f]['label'];
					// If item doesnt already exist, create it and insert current event data then add to array of items
					// if item already exists, get it
					if (doesItemAlreadyExist(attributeLabel)) {
						var currItem = getItemByNumber(attributeLabel);
					} else {
						var currItem = new Item(attributeLabel);
						items.push(currItem);
					}
						//console.log(attributeName);
						// !!!! going to set attribute time instead of event time, change if not correct
						currItem.lastScan = parsedJSON['trackeableEntities']['trackeableEntity']['0']['events']['trackeableEntityEvent'][i]['attributes']['attribute'][f]['value'];
						//console.log('updating item desc from ' + currItem.description + ' to ' + eventDesc);
						currItem.description = eventDesc;
						currItem.itemLoc = eventLoc;						
					}
				}
			}
		}
	//}
		
	
	function getItemByNumber(itemNumber){
	var test = 0;
		var foundItem;
		for (var i = 0; i < items.length;i++ ) {
			if (items[i].itemNumber == itemNumber) {
				foundItem = items[i];
				test++;
			}
		}
		alert('this should always be 0 or 1: getItemByNumber()');
		return foundItem;
	}
	
	
	function doesItemAlreadyExist(itemNumber){
	//alert('does ' + itemNumber + ' exist?')
		var result = false;
		for (var i = 0; i < items.length;i++ ) {
			if (items[i].itemNumber == itemNumber) {
				result = true;
			}
		}
		return result;
	}
//}

/*var oReq = new XMLHttpRequest();
oReq.addEventListener("load", reqListener);
oReq.open("GET", "https://m.tollgroup.com/mobile/trackandtrace/b2c?t=generic&source=mobile&v=2&Action=SearchConnotesRequest&Connote=8370561609200000609");
oReq.send();
alert('loading con data.');
*/




// test by printing contents of items
console.log('--------------');
console.log('item count: ' + items.length);
for (var i=0;i<items.length;i++) {
	console.log('--------------');
	console.log('item ID: ' + items[i].itemNumber);
	console.log('item description: ' + items[i].description);
	console.log('item location: ' + items[i].itemLoc);
	console.log('item last scan: ' + items[i].lastScan);
}



</script>
	
	<script> 
	// When a row of the table is clicked, render barcode
 $('.table > tbody > tr').click(function() {
	console.log('Creating barcode for \'' + this.cells[0].innerHTML + '\'');
	barcodeID = this.cells[0].innerHTML;
	render(barcodeID);
});
</script>
	
	

	
	
	<div class="col-md-4"></div>
	<div class="container col-md-4">
	<br>
  <table class="table table-striped " id="barcodeTable">
      <tr>
        <th class="text-center">Item #</th>
		<th class="text-center">Description</th>
		<th class="text-center">Location</th>
		<th class="text-center">Time</th>
      </tr>
  </table>


	<script>	
	// Update table of barcodes
	for (var i = 0;i < items.length ; i++) {
		var row = $("<tr>");

		row.append($("<td>" + items[i].itemNumber + "</td>"))
		 .append($("<td>" + items[i].description + "</td>"))
		 .append($("<td>" + items[i].itemLoc + "</td>"))
		 .append($("<td>" + items[i].lastScan + "</td>"));
	 
		$("#barcodeTable tbody").append(row);
  
	}
	</script>




<table border=0 cellpading=0 cellspacing=0><tr>
<td style="vertical-align:top">
	<table border=0 cellpading=0 cellspacing=0>
		<select type="hidden" id="symbol" style="width:63.5ex; display:none">
			<option value="sscc18">SSCC-18</option>
			<option value="code128">Code 128</option>
		</select>
	<input id="symaltx" type="hidden" style="width:63ex">
	<input id="symopts" type="hidden" style="width:63ex">
	<tr>
	</table>
	
<td style="padding-left:10mm;vertical-align:top">
<tr><td><br>
</table>
<div id="content">
<canvas id="canvas" width=1 height=1 style="border:5px solid #fff;visibility:hidden"></canvas>
<div id="output" style="white-space:pre"></div>
</div>
		
		</div>
		
		
		
		
</div>
    </div>
	
	<script type="text/javascript" src="freetype.js"></script>
<script type="text/javascript" src="bwipp.js"></script>
<script type="text/javascript" src="bwipjs.js"></script>
<script type="text/javascript" src="lib/bitmap.js"></script>
<script type="text/javascript" src="lib/symdesc.js"></script>
<script type="text/javascript" src="lib/canvas-toblob.js"></script>
<script type="text/javascript" src="lib/filesaver.js"></script>
<script type="text/javascript" src="lib/barcodeRender.js"></script>
	</body>